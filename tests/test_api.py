"""
Tests for API queries
"""

import pytest
import geopandas as gpd
import numpy as np
from numpy.testing import assert_almost_equal


def test_timeseries_lambda_handler_geojson(hydrocron_api):
    """
    Test the lambda handler for the timeseries endpoint
    Parameters
    ----------
    hydrocron_api: Fixture ensuring the database is configured for the api
    """
    import hydrocron.api.controllers.timeseries

    event = {
        "body": {
            "feature": "Reach",
            "feature_id": "71224100223",
            "start_time": "2023-06-04T00:00:00Z",
            "end_time": "2023-06-23T00:00:00Z",
            "output": "geojson",
            "fields": "reach_id,time_str,wse"
        }
    }

    context = "_"
    result = hydrocron.api.controllers.timeseries.lambda_handler(event, context)
    assert result['status'] == '200 OK' and \
           result['results']['geojson'] == {'type': 'FeatureCollection', 'features': [
                    {'id': '0', 'properties': {'reach_id': '71224100223', 'time_str': '2023-06-10T19:39:43Z',
                    'wse': '286.2983'}, 'geometry': {'coordinates':
                    [[-95.564991, 50.223686], [-95.564559, 50.223479],
                    [-95.564133, 50.223381],
                    [-95.563713, 50.22339], [-95.563296, 50.223453],
                    [-95.562884, 50.223624],
                    [-95.562473, 50.223795], [-95.562062, 50.223966],
                    [-95.56165, 50.224137],
                    [-95.561242, 50.224362], [-95.560917, 50.224585],
                    [-95.560595, 50.224862],
                    [-95.560271, 50.225085], [-95.559946, 50.225308],
                    [-95.559946, 50.225308],
                    [-95.559213, 50.225756], [-95.558804, 50.225981],
                    [-95.558567, 50.226256],
                    [-95.558413, 50.226529], [-95.558343, 50.226801],
                    [-95.558274, 50.227072],
                    [-95.558288, 50.227342], [-95.558303, 50.227611],
                    [-95.558317, 50.227881],
                    [-95.558416, 50.228148], [-95.558514, 50.228416],
                    [-95.558697, 50.228682],
                    [-95.558795, 50.22895], [-95.558978, 50.229216],
                    [-95.559076, 50.229483],
                    [-95.559259, 50.229749], [-95.559357, 50.230017],
                    [-95.559455, 50.230284],
                    [-95.55947, 50.230554], [-95.559484, 50.230823],
                    [-95.559583, 50.231091],
                    [-95.559765, 50.231357], [-95.559864, 50.231625],
                    [-95.559878, 50.231894],
                    [-95.559809, 50.232166], [-95.559571, 50.232441],
                    [-95.559165, 50.23272],
                    [-95.558757, 50.232944], [-95.558348, 50.233169],
                    [-95.557939, 50.233394],
                    [-95.55753, 50.233619], [-95.557206, 50.233842],
                    [-95.556884, 50.234119],
                    [-95.556562, 50.234396], [-95.556241, 50.234673],
                    [-95.556003, 50.234948],
                    [-95.555681, 50.235225], [-95.555443, 50.2355],
                    [-95.555206, 50.235775],
                    [-95.555136, 50.236047], [-95.555066, 50.236318],
                    [-95.555081, 50.236588],
                    [-95.555011, 50.236859], [-95.554941, 50.23713],
                    [-95.554701, 50.237351],
                    [-95.554376, 50.237575], [-95.554052, 50.237798],
                    [-95.553727, 50.238021],
                    [-95.553727, 50.238021], [-95.55308, 50.238521],
                    [-95.552843, 50.238796],
                    [-95.552521, 50.239073], [-95.552367, 50.239346],
                    [-95.552297, 50.239617],
                    [-95.552312, 50.239887], [-95.552326, 50.240156],
                    [-95.552425, 50.240424],
                    [-95.552439, 50.240693], [-95.552453, 50.240963],
                    [-95.552468, 50.241233],
                    [-95.552482, 50.241502], [-95.552497, 50.241772],
                    [-95.552511, 50.242041],
                    [-95.552525, 50.242311], [-95.552456, 50.242582],
                    [-95.552299, 50.242801],
                    [-95.552056, 50.242969], [-95.551728, 50.243138],
                    [-95.551314, 50.243255],
                    [-95.550899, 50.243372], [-95.550487, 50.243543],
                    [-95.550076, 50.243714],
                    [-95.549661, 50.243831], [-95.549249, 50.244002],
                    [-95.548838, 50.244173],
                    [-95.548423, 50.24429], [-95.548011, 50.244461],
                    [-95.547603, 50.244686],
                    [-95.547278, 50.244909], [-95.546953, 50.245132],
                    [-95.546715, 50.245407],
                    [-95.546561, 50.24568], [-95.546492, 50.245951],
                    [-95.546422, 50.246223],
                    [-95.546436, 50.246492], [-95.546367, 50.246764],
                    [-95.546297, 50.247035],
                    [-95.546143, 50.247308], [-95.54599, 50.247582],
                    [-95.545752, 50.247857],
                    [-95.545598, 50.24813], [-95.545444, 50.248403],
                    [-95.545374, 50.248674],
                    [-95.545305, 50.248946], [-95.545319, 50.249215],
                    [-95.545333, 50.249485],
                    [-95.545348, 50.249754], [-95.545446, 50.250022],
                    [-95.545545, 50.25029],
                    [-95.545727, 50.250556], [-95.54591, 50.250822],
                    [-95.546176, 50.251086],
                    [-95.546359, 50.251351], [-95.546625, 50.251615],
                    [-95.546892, 50.251879],
                    [-95.547075, 50.252145], [-95.547257, 50.252411],
                    [-95.54744, 50.252677],
                    [-95.547538, 50.252945], [-95.547553, 50.253214],
                    [-95.547651, 50.253482],
                    [-95.547581, 50.253753], [-95.547512, 50.254025],
                    [-95.547442, 50.254296],
                    [-95.547372, 50.254568], [-95.547303, 50.254839],
                    [-95.547317, 50.255108],
                    [-95.547247, 50.25538], [-95.547177, 50.255651],
                    [-95.547192, 50.255921],
                    [-95.547206, 50.25619], [-95.547221, 50.25646],
                    [-95.547319, 50.256728],
                    [-95.547418, 50.256995], [-95.547432, 50.257265],
                    [-95.547446, 50.257534],
                    [-95.547461, 50.257804], [-95.547475, 50.258073],
                    [-95.547489, 50.258343],
                    [-95.547504, 50.258613], [-95.547518, 50.258882],
                    [-95.547449, 50.259153],
                    [-95.547379, 50.259425], [-95.547309, 50.259696],
                    [-95.547239, 50.259968],
                    [-95.547086, 50.260241], [-95.547016, 50.260512],
                    [-95.546946, 50.260784],
                    [-95.546876, 50.261055], [-95.546807, 50.261326],
                    [-95.546737, 50.261598],
                    [-95.546583, 50.261871], [-95.546345, 50.262146],
                    [-95.54602, 50.262369],
                    [-95.545611, 50.262594], [-95.5452, 50.262765],
                    [-95.544788, 50.262936],
                    [-95.544373, 50.263053], [-95.543961, 50.263224],
                    [-95.543546, 50.263341],
                    [-95.543135, 50.263512], [-95.542723, 50.263683],
                    [-95.542314, 50.263907],
                    [-95.541989, 50.26413], [-95.541667, 50.264407],
                    [-95.541345, 50.264684],
                    [-95.541107, 50.264959], [-95.540869, 50.265234],
                    [-95.540631, 50.265509],
                    [-95.540393, 50.265785], [-95.540155, 50.26606],
                    [-95.539917, 50.266335],
                    [-95.539679, 50.26661], [-95.539441, 50.266885],
                    [-95.539203, 50.26716],
                    [-95.538962, 50.267381], [-95.538634, 50.26755],
                    [-95.538304, 50.267665],
                    [-95.537889, 50.267782], [-95.537471, 50.267845],
                    [-95.537056, 50.267962],
                    [-95.536642, 50.268079], [-95.536227, 50.268196],
                    [-95.535809, 50.268259],
                    [-95.535391, 50.268323], [-95.534974, 50.268386],
                    [-95.534556, 50.268449],
                    [-95.534138, 50.268512], [-95.533718, 50.268521],
                    [-95.5333, 50.268584],
                    [-95.532882, 50.268647], [-95.532552, 50.268762],
                    [-95.532224, 50.268931],
                    [-95.531986, 50.269206], [-95.531748, 50.269481],
                    [-95.531594, 50.269755],
                    [-95.531356, 50.27003], [-95.531202, 50.270303],
                    [-95.531048, 50.270576],
                    [-95.530978, 50.270847], [-95.530908, 50.271119],
                    [-95.530923, 50.271388],
                    [-95.530937, 50.271658], [-95.530951, 50.271927],
                    [-95.53105, 50.272195],
                    [-95.531148, 50.272463], [-95.531331, 50.272729],
                    [-95.531513, 50.272995],
                    [-95.531696, 50.273261], [-95.531878, 50.273526],
                    [-95.532145, 50.27379],
                    [-95.532327, 50.274056], [-95.532594, 50.27432],
                    [-95.532861, 50.274584],
                    [-95.533043, 50.27485], [-95.533142, 50.275118],
                    [-95.53324, 50.275386],
                    [-95.533339, 50.275653], [-95.533437, 50.275921],
                    [-95.533536, 50.276189],
                    [-95.533634, 50.276457], [-95.533732, 50.276724],
                    [-95.533747, 50.276994],
                    [-95.533761, 50.277263], [-95.533859, 50.277531],
                    [-95.533958, 50.277799],
                    [-95.53414, 50.278065], [-95.534323, 50.278331],
                    [-95.534506, 50.278596],
                    [-95.534688, 50.278862], [-95.534871, 50.279128],
                    [-95.534969, 50.279396],
                    [-95.535152, 50.279662], [-95.535334, 50.279928],
                    [-95.535433, 50.280195],
                    [-95.535615, 50.280461], [-95.535798, 50.280727],
                    [-95.535812, 50.280997],
                    [-95.535743, 50.281268], [-95.535589, 50.281541],
                    [-95.535266, 50.281818],
                    [-95.53486, 50.282097], [-95.534454, 50.282376],
                    [-95.534132, 50.282652],
                    [-95.533893, 50.282927], [-95.533824, 50.283199],
                    [-95.533838, 50.283468],
                    [-95.534021, 50.283734], [-95.534203, 50.284],
                    [-95.53447, 50.284264],
                    [-95.534652, 50.28453], [-95.534835, 50.284796],
                    [-95.535018, 50.285062],
                    [-95.5352, 50.285328], [-95.535383, 50.285594],
                    [-95.535565, 50.285859],
                    [-95.535832, 50.286123], [-95.536099, 50.286387],
                    [-95.53645, 50.28665],
                    [-95.536801, 50.286912], [-95.537152, 50.287174],
                    [-95.537418, 50.287438],
                    [-95.537601, 50.287704], [-95.5377, 50.287972],
                    [-95.537798, 50.288239],
                    [-95.537897, 50.288507], [-95.537995, 50.288775],
                    [-95.538093, 50.289043],
                    [-95.538192, 50.28931], [-95.538206, 50.28958],
                    [-95.538221, 50.289849],
                    [-95.538235, 50.290119], [-95.538334, 50.290387],
                    [-95.538432, 50.290654],
                    [-95.538531, 50.290922], [-95.538629, 50.29119]],
                    'type': 'LineString'}, 'type': 'Feature'}]}


def test_timeseries_lambda_handler_csv(hydrocron_api):
    """
    Test the lambda handler for the timeseries endpoint
    Parameters
    ----------
    hydrocron_api: Fixture ensuring the database is configured for the api
    """

    import hydrocron.api.controllers.timeseries

    event = {
        "body": {
            "feature": "Reach",
            "feature_id": "71224100223",
            "start_time": "2023-06-04T00:00:00Z",
            "end_time": "2023-06-23T00:00:00Z",
            "output": "csv",
            "fields": "reach_id,time_str,wse,geometry"
        }
    }

    context = "_"
    result = hydrocron.api.controllers.timeseries.lambda_handler(event, context)
    assert result['status'] == '200 OK'
    assert result['results']['csv'] == ('reach_id,time_str,wse,geometry\n' \
                                        '71224100223,2023-06-10T19:39:43Z,286.2983,"LINESTRING (-95.564991 50.223686, ' \
                                        '-95.564559 50.223479, -95.564133 50.223381, -95.563713 50.22339, -95.563296 ' \
                                        '50.223453, -95.562884 50.223624, -95.562473 50.223795, -95.562062 50.223966, ' \
                                        '-95.56165 50.224137, -95.561242 50.224362, -95.560917 50.224585, -95.560595 ' \
                                        '50.224862, -95.560271 50.225085, -95.559946 50.225308, -95.559946 50.225308, ' \
                                        '-95.559213 50.225756, -95.558804 50.225981, -95.558567 50.226256, -95.558413 ' \
                                        '50.226529, -95.558343 50.226801, -95.558274 50.227072, -95.558288 50.227342, ' \
                                        '-95.558303 50.227611, -95.558317 50.227881, -95.558416 50.228148, -95.558514 ' \
                                        '50.228416, -95.558697 50.228682, -95.558795 50.22895, -95.558978 50.229216, ' \
                                        '-95.559076 50.229483, -95.559259 50.229749, -95.559357 50.230017, -95.559455 ' \
                                        '50.230284, -95.55947 50.230554, -95.559484 50.230823, -95.559583 50.231091, ' \
                                        '-95.559765 50.231357, -95.559864 50.231625, -95.559878 50.231894, -95.559809 ' \
                                        '50.232166, -95.559571 50.232441, -95.559165 50.23272, -95.558757 50.232944, ' \
                                        '-95.558348 50.233169, -95.557939 50.233394, -95.55753 50.233619, -95.557206 ' \
                                        '50.233842, -95.556884 50.234119, -95.556562 50.234396, -95.556241 50.234673, ' \
                                        '-95.556003 50.234948, -95.555681 50.235225, -95.555443 50.2355, -95.555206 ' \
                                        '50.235775, -95.555136 50.236047, -95.555066 50.236318, -95.555081 50.236588, ' \
                                        '-95.555011 50.236859, -95.554941 50.23713, -95.554701 50.237351, -95.554376 ' \
                                        '50.237575, -95.554052 50.237798, -95.553727 50.238021, -95.553727 50.238021, ' \
                                        '-95.55308 50.238521, -95.552843 50.238796, -95.552521 50.239073, -95.552367 ' \
                                        '50.239346, -95.552297 50.239617, -95.552312 50.239887, -95.552326 50.240156, ' \
                                        '-95.552425 50.240424, -95.552439 50.240693, -95.552453 50.240963, -95.552468 ' \
                                        '50.241233, -95.552482 50.241502, -95.552497 50.241772, -95.552511 50.242041, ' \
                                        '-95.552525 50.242311, -95.552456 50.242582, -95.552299 50.242801, -95.552056 ' \
                                        '50.242969, -95.551728 50.243138, -95.551314 50.243255, -95.550899 50.243372, ' \
                                        '-95.550487 50.243543, -95.550076 50.243714, -95.549661 50.243831, -95.549249 ' \
                                        '50.244002, -95.548838 50.244173, -95.548423 50.24429, -95.548011 50.244461, ' \
                                        '-95.547603 50.244686, -95.547278 50.244909, -95.546953 50.245132, -95.546715 ' \
                                        '50.245407, -95.546561 50.24568, -95.546492 50.245951, -95.546422 50.246223, ' \
                                        '-95.546436 50.246492, -95.546367 50.246764, -95.546297 50.247035, -95.546143 ' \
                                        '50.247308, -95.54599 50.247582, -95.545752 50.247857, -95.545598 50.24813, ' \
                                        '-95.545444 50.248403, -95.545374 50.248674, -95.545305 50.248946, -95.545319 ' \
                                        '50.249215, -95.545333 50.249485, -95.545348 50.249754, -95.545446 50.250022, ' \
                                        '-95.545545 50.25029, -95.545727 50.250556, -95.54591 50.250822, -95.546176 ' \
                                        '50.251086, -95.546359 50.251351, -95.546625 50.251615, -95.546892 50.251879, ' \
                                        '-95.547075 50.252145, -95.547257 50.252411, -95.54744 50.252677, -95.547538 ' \
                                        '50.252945, -95.547553 50.253214, -95.547651 50.253482, -95.547581 50.253753, ' \
                                        '-95.547512 50.254025, -95.547442 50.254296, -95.547372 50.254568, -95.547303 ' \
                                        '50.254839, -95.547317 50.255108, -95.547247 50.25538, -95.547177 50.255651, ' \
                                        '-95.547192 50.255921, -95.547206 50.25619, -95.547221 50.25646, -95.547319 ' \
                                        '50.256728, -95.547418 50.256995, -95.547432 50.257265, -95.547446 50.257534, ' \
                                        '-95.547461 50.257804, -95.547475 50.258073, -95.547489 50.258343, -95.547504 ' \
                                        '50.258613, -95.547518 50.258882, -95.547449 50.259153, -95.547379 50.259425, ' \
                                        '-95.547309 50.259696, -95.547239 50.259968, -95.547086 50.260241, -95.547016 ' \
                                        '50.260512, -95.546946 50.260784, -95.546876 50.261055, -95.546807 50.261326, ' \
                                        '-95.546737 50.261598, -95.546583 50.261871, -95.546345 50.262146, -95.54602 ' \
                                        '50.262369, -95.545611 50.262594, -95.5452 50.262765, -95.544788 50.262936, ' \
                                        '-95.544373 50.263053, -95.543961 50.263224, -95.543546 50.263341, -95.543135 ' \
                                        '50.263512, -95.542723 50.263683, -95.542314 50.263907, -95.541989 50.26413, ' \
                                        '-95.541667 50.264407, -95.541345 50.264684, -95.541107 50.264959, -95.540869 ' \
                                        '50.265234, -95.540631 50.265509, -95.540393 50.265785, -95.540155 50.26606, ' \
                                        '-95.539917 50.266335, -95.539679 50.26661, -95.539441 50.266885, -95.539203 ' \
                                        '50.26716, -95.538962 50.267381, -95.538634 50.26755, -95.538304 50.267665, ' \
                                        '-95.537889 50.267782, -95.537471 50.267845, -95.537056 50.267962, -95.536642 ' \
                                        '50.268079, -95.536227 50.268196, -95.535809 50.268259, -95.535391 50.268323, ' \
                                        '-95.534974 50.268386, -95.534556 50.268449, -95.534138 50.268512, -95.533718 ' \
                                        '50.268521, -95.5333 50.268584, -95.532882 50.268647, -95.532552 50.268762, ' \
                                        '-95.532224 50.268931, -95.531986 50.269206, -95.531748 50.269481, -95.531594 ' \
                                        '50.269755, -95.531356 50.27003, -95.531202 50.270303, -95.531048 50.270576, ' \
                                        '-95.530978 50.270847, -95.530908 50.271119, -95.530923 50.271388, -95.530937 ' \
                                        '50.271658, -95.530951 50.271927, -95.53105 50.272195, -95.531148 50.272463, ' \
                                        '-95.531331 50.272729, -95.531513 50.272995, -95.531696 50.273261, -95.531878 ' \
                                        '50.273526, -95.532145 50.27379, -95.532327 50.274056, -95.532594 50.27432, ' \
                                        '-95.532861 50.274584, -95.533043 50.27485, -95.533142 50.275118, -95.53324 ' \
                                        '50.275386, -95.533339 50.275653, -95.533437 50.275921, -95.533536 50.276189, ' \
                                        '-95.533634 50.276457, -95.533732 50.276724, -95.533747 50.276994, -95.533761 ' \
                                        '50.277263, -95.533859 50.277531, -95.533958 50.277799, -95.53414 50.278065, ' \
                                        '-95.534323 50.278331, -95.534506 50.278596, -95.534688 50.278862, -95.534871 ' \
                                        '50.279128, -95.534969 50.279396, -95.535152 50.279662, -95.535334 50.279928, ' \
                                        '-95.535433 50.280195, -95.535615 50.280461, -95.535798 50.280727, -95.535812 ' \
                                        '50.280997, -95.535743 50.281268, -95.535589 50.281541, -95.535266 50.281818, ' \
                                        '-95.53486 50.282097, -95.534454 50.282376, -95.534132 50.282652, -95.533893 ' \
                                        '50.282927, -95.533824 50.283199, -95.533838 50.283468, -95.534021 50.283734, ' \
                                        '-95.534203 50.284, -95.53447 50.284264, -95.534652 50.28453, -95.534835 ' \
                                        '50.284796, -95.535018 50.285062, -95.5352 50.285328, -95.535383 50.285594, ' \
                                        '-95.535565 50.285859, -95.535832 50.286123, -95.536099 50.286387, -95.53645 ' \
                                        '50.28665, -95.536801 50.286912, -95.537152 50.287174, -95.537418 50.287438, ' \
                                        '-95.537601 50.287704, -95.5377 50.287972, -95.537798 50.288239, -95.537897 ' \
                                        '50.288507, -95.537995 50.288775, -95.538093 50.289043, -95.538192 50.28931, ' \
                                        '-95.538206 50.28958, -95.538221 50.289849, -95.538235 50.290119, -95.538334 ' \
                                        '50.290387, -95.538432 50.290654, -95.538531 50.290922, -95.538629 ' \
                                        '50.29119)"\n')


def test_timeseries_convert_to_df_node(hydrocron_api):
    """
    Test conver_to_df function to make sure it creates a correctly formatted
    GeoDataFrame.
    """
    import hydrocron.api.controllers.timeseries

    items = [{'range_start_time': '2023-04-18T03:59:34Z', 'area_total': '-999999999999.0', 'river_name': 'no_data', \
        'dark_frac': '0.02289615234', 'p_n_ch_mod': '3', 'wse': '321.96264', 'range_end_time': '2023-04-18T03:59:42Z', \
        'p_wid_var': '1015753.04', 'time_str': '2023-04-18T04:05:30Z', 'rdr_sig0_u': '0.31886076', 'rdr_pol': 'V', \
        'p_dist_out': '418802.468', 'p_length': '181.79465149', 'time_tai': '735105967.355', 'lat': '49.30171806', \
        'reach_id': '71224300473', 'node_q_b': '4194335', 'pole_tide': '-0.0017156485', 'p_width': '12253.0', \
        'lon_u': '6.01691e-06', 'n_good_pix': '1804', 'area_det_u': '-999999999999.0', 'ice_dyn_f': '-999', \
        'area_detct': '-999999999999.0', 'load_tideg': '0.0047302109', 'xovr_cal_c': '-0.258314908', 'pass_id': \
        '011', 'lon': '-94.8189988', 'lat_u': '1.18486e-06', 'wse_r_u': '0.00832', 'area_tot_u': '-999999999999.0', \
        'load_tidef': '0.0050830623', 'layovr_val': '0.0309', 'xtrk_dist': '13912.33984', 'xovr_cal_q': '0', \
        'geoid_hght': '-29.8400594', 'width_u': '-999999999999.0', 'continent_id': 'NA', 'ice_clim_f': '1', \
        'p_wse_var': '0.0', 'area_wse': '-999999999999.0', 'dry_trop_c': '-2.228623629', 'cycle_id': '494', \
        'p_n_ch_max': '7', 'crid': 'PIB0', 'solid_tide': '0.0559434783', 'p_wse': '319.2', 'rdr_sig0': '22.25', \
        'flow_angle': '52.0267437', 'node_q': '3', 'wet_trop_c': '-0.0258554462', 'iono_c': '-0.0040178783', \
        'width': '-999999999999.0', 'geometry': 'POINT (-94.843707 49.290181)', 'time': '735105930.355', \
        'p_dam_id': '0', 'wse_u': '0.09038', 'node_id': '71224300470093', 'node_dist': '2493.5817691'}, \
        {'range_start_time': '2023-04-22T03:22:06Z', 'area_total': '-999999999999.0', 'river_name': 'no_data', \
        'dark_frac': '0.49865569397', 'p_n_ch_mod': '3', 'wse': '322.36606', 'range_end_time': \
        '2023-04-22T03:22:13Z', 'p_wid_var': '1015753.04', 'time_str': '2023-04-22T03:28:01Z', \
        'rdr_sig0_u': '0.20670255', 'rdr_pol': 'V', 'p_dist_out': '418802.468', 'p_length': '181.79465149', \
        'time_tai': '735449318.534', 'lat': '49.30717892', 'reach_id': '71224300473', 'node_q_b': '4194335', \
        'pole_tide': '-0.0019577795', 'p_width': '12253.0', 'lon_u': '8.71089e-06', 'n_good_pix': '970', \
        'area_det_u': '-999999999999.0', 'ice_dyn_f': '-999', 'area_detct': '-999999999999.0', \
        'load_tideg': '-0.0090207256', 'xovr_cal_c': '0.0', 'pass_id': '011', 'lon': '-94.8058823', \
        'lat_u': '1.7161e-06', 'wse_r_u': '0.01233', 'area_tot_u': '-999999999999.0', 'load_tidef': '-0.0082753772', \
        'layovr_val': '0.0492', 'xtrk_dist': '13686.02148', 'xovr_cal_q': '2', 'geoid_hght': '-29.8535868', \
        'width_u': '-999999999999.0', 'continent_id': 'NA', 'ice_clim_f': '1', 'p_wse_var': '0.0', \
        'area_wse': '-999999999999.0', 'dry_trop_c': '-2.230585814', 'cycle_id': '498', 'p_n_ch_max': '7', \
        'crid': 'PIB0', 'solid_tide': '-0.1039548086', 'p_wse': '319.2', 'rdr_sig0': '14.235', \
        'flow_angle': '51.3242365', 'node_q': '3', 'wet_trop_c': '-0.0503667332', 'iono_c': '-0.0044649253', \
        'width': '-999999999999.0', 'geometry': 'POINT (-94.843707 49.290181)', 'time': '735449281.534', \
        'p_dam_id': '0', 'wse_u': '0.09084', 'node_id': '71224300470093', 'node_dist': '2329.1377584'}]

    gdf = hydrocron.api.controllers.timeseries.convert_to_df(items)
    assert_almost_equal(np.array([321.96264, 322.36606], dtype=np.float64), gdf['wse'].to_numpy().astype(np.float64))
    assert_almost_equal(np.array([-999999999999.0, -999999999999.0], dtype=np.float64), gdf['width'].to_numpy().astype(np.float64))
    assert_almost_equal(np.array([735105930.355, 735449281.534], dtype=np.float64), gdf['time'].to_numpy().astype(np.float64))
    geo_array = gpd.points_from_xy(x=[-94.844, -94.844], y=[49.29, 49.29]).to_numpy()
    assert str(geo_array) == str(gdf['geometry'].to_numpy())


def test_timeseries_convert_to_df_reach(hydrocron_api):
    """
    Test conver_to_df function to make sure it creates a correctly formatted
    GeoDataFrame.
    """
    import hydrocron.api.controllers.timeseries

    items = [{'area_total': '105801.1', 'dschg_gcsf': '-999999999999', 'dschg_b': '-999999999999.0', 'p_lat': '34.20670437', 'dschg_c': '-999999999999.0', 'wse': '478.2167', 'p_wid_var': '143.536', 'dschg_h': '-999999999999.0', 'dschg_i': '-999999999999.0', 'loc_offset': '709.43475', 'dschg_hsf': '-999999999999', 'slope2_u': '-999999999999.0', 'time_tai': '735105690.492', 'p_n_nodes': '79', 'dschg_gb_q': '-999', 'reach_id': '74227800151', 'dschg_o_u': '-999999999999.0', 'dschg_s_q': '-999', 'dschg_gb_u': '-999999999999.0', 'dschg_s_u': '-999999999999.0', 'reach_q_b': '52230', 'slope': '0.0010608586', 'dschg_o_q': '-999', 'dschg_m': '-999999999999.0', 'dschg_c_q': '-999', 'dschg_o': '-999999999999.0', 'dschg_c_u': '-999999999999.0', 'dschg_s': '-999999999999.0', 'dschg_ghsf': '-999999999999', 'p_low_slp': '0', 'area_det_u': '5108.0', 'slope_r_u': '8.239231e-05', 'dschg_ssf': '-999999999999', 'load_tideg': '0.0027443631', 'dschg_gbsf': '-999999999999', 'wse_r_u': '8.66974', 'dschg_osf': '-999999999999', 'load_tidef': '0.0021248074', 'dschg_gm_u': '-999999999999.0', 'dschg_csf': '-999999999999', 'width_c_u': '-999999999999.0', 'p_maf': '-999999999999.0', 'dschg_gi_q': '-999', 'obs_frac_n': '0.17721518987', 'dschg_gm_q': '-999', 'dschg_gi_u': '-999999999999.0', 'p_wse_var': '36.6891653', 'dschg_gq_b': '-99999999', 'dry_trop_c': '-2.179414895', 'd_x_area_u': '-999999999999.0', 'rch_id_dn': '74227800131, no_data, no_data, no_data', 'wse_c': '-999999999999.0', 'dschg_b_q': '-999', 'dschg_gssf': '-999999999999', 'dschg_b_u': '-999999999999.0', 'width': '16.677122', 'geometry': 'LINESTRING (-100.124087 34.237217, -100.124087 34.237217, -100.124413 34.237214, -100.124741 34.237373, -100.125068 34.237478, -100.125395 34.237584, -100.125721 34.237581, -100.126046 34.237578, -100.126373 34.237629, -100.126698 34.237626, -100.127024 34.237623, -100.127351 34.237674, -100.127676 34.237671, -100.128001 34.237614, -100.128326 34.237557, -100.128651 34.2375, -100.128976 34.237443, -100.129301 34.237385, -100.129626 34.237328, -100.129951 34.237271, -100.130275 34.23716, -100.1306 34.237049, -100.130924 34.236938, -100.131248 34.236826, -100.131572 34.236715, -100.131897 34.236604, -100.13222 34.236439, -100.132544 34.236273, -100.132867 34.236108, -100.13319 34.235889, -100.133513 34.235669, -100.133771 34.23545, -100.133963 34.235232, -100.134155 34.23496, -100.134282 34.234688, -100.134408 34.234416, -100.1346 34.234144, -100.134792 34.233872, -100.134918 34.2336, -100.13511 34.233328, -100.135237 34.233056, -100.135363 34.232784, -100.13549 34.232513, -100.135682 34.23224, -100.135809 34.231969, -100.135935 34.231697, -100.136062 34.231425, -100.136254 34.231153, -100.136445 34.230881, -100.136702 34.230608, -100.137026 34.230442, -100.137349 34.230277, -100.137673 34.230166, -100.137998 34.230109, -100.138324 34.230106, -100.138648 34.229994, -100.138973 34.229937, -100.139297 34.229826, -100.139621 34.229661, -100.139944 34.229495, -100.140526 34.229111, -100.140526 34.229111, -100.140783 34.228892, -100.140976 34.228674, -100.141167 34.228402, -100.141294 34.22813, -100.141421 34.227858, -100.141482 34.227587, -100.141544 34.227316, -100.141475 34.227046, -100.141341 34.226777, -100.141207 34.226508, -100.141008 34.226239, -100.140809 34.22597, -100.14061 34.225702, -100.140476 34.225432, -100.140342 34.225163, -100.140273 34.224893, -100.140139 34.224624, -100.140071 34.224354, -100.140002 34.224084, -100.139933 34.223814, -100.139864 34.223544, -100.139926 34.223273, -100.139987 34.223002, -100.140049 34.222731, -100.14011 34.22246, -100.140172 34.222189, -100.140168 34.221918, -100.140164 34.221648, -100.140226 34.221377, -100.140287 34.221106, -100.140414 34.220834, -100.140606 34.220562, -100.140797 34.220289, -100.141247 34.219798, -100.141247 34.219798, -100.141504 34.219579, -100.141762 34.21936, -100.142085 34.219195, -100.14241 34.219084, -100.142734 34.218973, -100.143058 34.218861, -100.143383 34.218804, -100.143708 34.218747, -100.144033 34.21869, -100.144358 34.218633, -100.144682 34.218576, -100.145007 34.218519, -100.145333 34.218515, -100.145658 34.218458, -100.145983 34.218401, -100.146308 34.218398, -100.146634 34.218395, -100.146958 34.218284, -100.147283 34.218227, -100.147608 34.21817, -100.147933 34.218112, -100.148258 34.218055, -100.148583 34.217998, -100.148908 34.217941, -100.149232 34.217884, -100.149557 34.217827, -100.149882 34.21777, -100.150208 34.217766, -100.150533 34.217709, -100.150858 34.217652, -100.151182 34.217595, -100.151507 34.217538, -100.151832 34.217481, -100.152158 34.217478, -100.152483 34.21742, -100.152808 34.217363, -100.153133 34.217306, -100.153457 34.217249, -100.153782 34.217192, -100.154108 34.217189, -100.154434 34.217186, -100.154758 34.217129, -100.155083 34.217071, -100.155408 34.217014, -100.155732 34.216903, -100.156057 34.216792, -100.156381 34.216734, -100.156706 34.216677, -100.15703 34.216566, -100.157355 34.216509, -100.157679 34.216398, -100.158003 34.216232, -100.158326 34.216067, -100.15865 34.215901, -100.158972 34.215682, -100.159296 34.215517, -100.159619 34.215351, -100.159877 34.215132, -100.160069 34.214914, -100.160261 34.214696, -100.160388 34.214424, -100.160449 34.214153, -100.160576 34.213881, -100.160702 34.21361, -100.160764 34.213338, -100.16089 34.213067, -100.161017 34.212795, -100.161078 34.212524, -100.16114 34.212253, -100.161266 34.211981, -100.161328 34.21171, -100.161389 34.211439, -100.16145 34.211168, -100.161512 34.210896, -100.161508 34.210626, -100.161504 34.210355, -100.161436 34.210086, -100.161367 34.209816, -100.161298 34.209546, -100.161164 34.209277, -100.160965 34.209008, -100.160831 34.208739, -100.160697 34.208469, -100.160563 34.2082, -100.160429 34.207931, -100.16036 34.207661, -100.160292 34.207391, -100.160158 34.207122, -100.160089 34.206852, -100.16015 34.206581, -100.160277 34.206309, -100.160469 34.206091, -100.160792 34.205925, -100.161117 34.205814, -100.161441 34.205757, -100.161767 34.205754, -100.162093 34.205751, -100.162418 34.205748, -100.162744 34.205745, -100.163069 34.205742, -100.163396 34.205793, -100.163722 34.205844, -100.164049 34.205949, -100.164376 34.206054, -100.164702 34.206105, -100.165028 34.206102, -100.165354 34.206099, -100.165678 34.205987, -100.165936 34.205823, -100.166129 34.205658, -100.166321 34.20544, -100.166448 34.205168, -100.166509 34.204897, -100.166636 34.204625, -100.166762 34.204354, -100.166824 34.204083, -100.166885 34.203812, -100.166946 34.20354, -100.167008 34.203269, -100.167069 34.202998, -100.167131 34.202727, -100.167192 34.202456, -100.167253 34.202185, -100.16725 34.201914, -100.167246 34.201644, -100.167307 34.201373, -100.167369 34.201102, -100.167495 34.20083, -100.167622 34.200558, -100.167748 34.200286, -100.16781 34.200015, -100.167936 34.199743, -100.168062 34.199472, -100.168254 34.199199, -100.168511 34.198926, -100.168833 34.198653, -100.169154 34.198379, -100.169476 34.198106, -100.169798 34.197832, -100.17012 34.197558, -100.170442 34.197285, -100.170698 34.197012, -100.170955 34.196739, -100.171212 34.196466, -100.171468 34.196193, -100.171726 34.195974, -100.172049 34.195808, -100.172373 34.195697, -100.172698 34.19564, -100.173024 34.195637, -100.173349 34.195634, -100.173675 34.195685, -100.174002 34.195736, -100.174328 34.195787, -100.174654 34.195838, -100.174981 34.195943, -100.175308 34.195994, -100.175634 34.196045, -100.175961 34.19615, -100.176288 34.196255, -100.176615 34.19636, -100.176943 34.196519, -100.177271 34.196678, -100.177598 34.196783, -100.177925 34.196943, -100.178253 34.197102, -100.17858 34.197207, -100.178908 34.197366, -100.179237 34.197579, -100.179565 34.197793, -100.179894 34.198006, -100.180222 34.198219, -100.18055 34.198378, -100.180878 34.198537, -100.181205 34.198642, -100.181531 34.198693, -100.181858 34.198798, -100.182185 34.198904, -100.182512 34.198954, -100.182838 34.199005, -100.183165 34.199111, -100.183491 34.199161, -100.183818 34.199212, -100.184144 34.199263, -100.18447 34.199314, -100.184796 34.199311, -100.185121 34.199308, -100.185448 34.199359, -100.185774 34.19941, -100.186101 34.199515, -100.186429 34.199674, -100.186692 34.199888, -100.186891 34.200103, -100.18709 34.200371, -100.187224 34.20064, -100.187293 34.20091, -100.187427 34.20118, -100.187561 34.201449, -100.18763 34.201719, -100.187764 34.201988, -100.187963 34.202256, -100.188097 34.202526, -100.188296 34.202794, -100.18856 34.203062, -100.188825 34.20333, -100.189088 34.203544, -100.189417 34.203757, -100.189745 34.203971, -100.190073 34.20413, -100.1904 34.204235, -100.190728 34.204394, -100.191055 34.204499, -100.191382 34.204604, -100.191709 34.204655, -100.192035 34.204706, -100.192361 34.204703, -100.192686 34.2047, -100.193011 34.204642, -100.193336 34.204639, -100.193662 34.204636, -100.193988 34.204633, -100.194313 34.20463, -100.194639 34.204626, -100.194964 34.204569, -100.195288 34.204458, -100.195612 34.204346, -100.195935 34.204181, -100.196257 34.203961, -100.196581 34.203796, -100.196904 34.20363, -100.197226 34.203411, -100.197549 34.203191, -100.197806 34.202972, -100.198063 34.202699, -100.198255 34.202427, -100.198316 34.202156, -100.198312 34.201885, -100.198308 34.201615, -100.198239 34.201345, -100.19817 34.201075, -100.198166 34.200805, -100.198163 34.200534, -100.198159 34.200264, -100.198155 34.199993, -100.198151 34.199723, -100.198147 34.199452, -100.198078 34.199182, -100.198009 34.198912, -100.19794 34.198642, -100.197872 34.198373, -100.197803 34.198103, -100.197799 34.197832, -100.197795 34.197562, -100.197791 34.197291, -100.197787 34.197021, -100.197783 34.19675, -100.19778 34.19648, -100.197776 34.196209, -100.197772 34.195939, -100.197768 34.195668, -100.197764 34.195398, -100.197761 34.195127, -100.197822 34.194856, -100.197948 34.194584, -100.19814 34.194312, -100.198396 34.194039, -100.198719 34.193819, -100.199041 34.1936, -100.199364 34.193434, -100.199688 34.193323, -100.200013 34.193266, -100.200337 34.193154, -100.200662 34.193097, -100.200987 34.19304, -100.201311 34.192928, -100.201635 34.192817, -100.201959 34.19276, -100.202284 34.192702, -100.202608 34.192591, -100.202933 34.192534, -100.203258 34.192476, -100.203582 34.192365, -100.203906 34.192254, -100.20423 34.192142, -100.204554 34.192031, -100.204878 34.191919, -100.205202 34.191862, -100.205526 34.191751, -100.205851 34.191693, -100.206176 34.191636, -100.206501 34.191579, -100.206825 34.191467, -100.207149 34.191356, -100.207473 34.191245, -100.207796 34.191079, -100.208118 34.190859, -100.208441 34.190694, -100.208765 34.190528, -100.209088 34.190363, -100.209412 34.190251, -100.209736 34.19014, -100.21006 34.190029, -100.210384 34.189971, -100.210709 34.189914, -100.211034 34.189857, -100.211359 34.189854, -100.211685 34.18985, -100.21201 34.189847, -100.212336 34.189844, -100.212662 34.189895, -100.212989 34.189946, -100.213316 34.190051, -100.213643 34.19021, -100.213971 34.190369, -100.214299 34.190528, -100.214627 34.190687, -100.214954 34.190792, -100.215281 34.190897, -100.215608 34.191002, -100.215934 34.190999, -100.216259 34.190995, -100.216585 34.190992, -100.216909 34.190935, -100.217234 34.190878, -100.21756 34.190874, -100.217885 34.190871, -100.21821 34.190814, -100.218535 34.19081, -100.21886 34.190753, -100.219185 34.190696, -100.219509 34.190584, -100.219833 34.190473, -100.220156 34.190307, -100.220479 34.190142, -100.220802 34.189976, -100.221126 34.189811, -100.221449 34.189699, -100.221773 34.189534, -100.222096 34.189368, -100.222419 34.189203, -100.222743 34.189091, -100.223067 34.18898, -100.223391 34.188868, -100.223716 34.188811, -100.22404 34.188754, -100.224364 34.188642, -100.224688 34.188531, -100.225013 34.188473, -100.225338 34.188416, -100.225662 34.188305, -100.225986 34.188247, -100.226311 34.18819, -100.226636 34.188133, -100.22696 34.188075, -100.227287 34.188126, -100.227613 34.188177, -100.227939 34.188228, -100.228266 34.188333, -100.228593 34.188438, -100.228921 34.188543, -100.229248 34.188702, -100.229512 34.188915, -100.230039 34.189343, -100.230039 34.189343, -100.230303 34.189557, -100.230303 34.189557, -100.230895 34.189984, -100.231223 34.190197, -100.231553 34.190464, -100.231882 34.190677, -100.23221 34.19089, -100.232538 34.191049, -100.232866 34.191208, -100.233194 34.191367, -100.233522 34.191526, -100.233849 34.191631, -100.234177 34.19179, -100.234504 34.191895, -100.23483 34.191946, -100.235156 34.191997, -100.235483 34.192048, -100.235809 34.192099, -100.236135 34.192149, -100.236462 34.1922, -100.236788 34.192251, -100.237114 34.192302, -100.23744 34.192299, -100.237765 34.192295, -100.238091 34.192292, -100.238416 34.192289, -100.238742 34.192285, -100.239067 34.192282, -100.239393 34.192279)', 'wse_u': '8.67021', 'node_dist': '89.9190847', 'dschg_gosf': '-999999999999', 'rch_id_up': '74227800176, no_data, no_data, no_data', 'range_start_time': '2023-04-18T03:59:34Z', 'river_name': 'no_data', 'dark_frac': '0.0', 'slope2': '0.00111963251', 'p_n_ch_mod': '1', 'range_end_time': '2023-04-18T03:59:42Z', 'n_good_nod': '14', 'time_str': '2023-04-18T04:00:53Z', 'dschg_bsf': '-999999999999', 'p_dist_out': '607722.998', 'p_length': '15733.121708', 'partial_f': '1', 'dschg_gh_u': '-999999999999.0', 'wse_c_u': '-999999999999.0', 'geoid_slop': '7.46456e-06', 'n_reach_up': '1', 'pole_tide': '-0.0018616217', 'p_width': '42.0', 'dschg_gh_q': '-999', 'dschg_m_q': '-999', 'dschg_i_u': '-999999999999.0', 'p_lon': '-100.1771731', 'dschg_m_u': '-999999999999.0', 'dschg_q_b': '-99999999', 'dschg_i_q': '-999', 'd_x_area': '-999999999999.0', 'ice_dyn_f': '-999', 'n_reach_dn': '1', 'area_detct': '105801.1', 'reach_q': '1', 'xovr_cal_c': '0.182512604', 'width_c': '-999999999999.0', 'dschg_gs': '-999999999999.0', 'pass_id': '011', 'dschg_gm': '-999999999999.0', 'dschg_isf': '-999999999999', 'area_tot_u': '5108.012', 'dschg_msf': '-999999999999', 'dschg_go': '-999999999999.0', 'dschg_go_u': '-999999999999.0', 'dschg_gs_q': '-999', 'layovr_val': '5.0217', 'xtrk_dist': '-9806.92969', 'dschg_gc': '-999999999999.0', 'xovr_cal_q': '0', 'geoid_hght': '-28.8910978', 'width_u': '0.805161', 'dschg_gi': '-999999999999.0', 'continent_id': 'NA', 'dschg_gh': '-999999999999.0', 'dschg_gs_u': '-999999999999.0', 'ice_clim_f': '0', 'dschg_gb': '-999999999999.0', 'dschg_go_q': '-999', 'area_wse': '105801.1', 'dschg_gc_q': '-999', 'cycle_id': '494', 'p_n_ch_max': '1', 'crid': 'PIB0', 'dschg_gc_u': '-999999999999.0', 'solid_tide': '0.10240261', 'slope_u': '8.244691e-05', 'dschg_h_u': '-999999999999.0', 'p_wse': '478.399994', 'slope2_r_u': '0.6500439294', 'wet_trop_c': '-0.10767358', 'dschg_h_q': '-999', 'iono_c': '-0.0048235932', 'dschg_gisf': '-999999999999', 'time': '735105653.492', 'p_dam_id': '0', 'dschg_gmsf': '-999999999999'}, {'area_total': '185303.6', 'dschg_gcsf': '-999999999999', 'dschg_b': '-999999999999.0', 'p_lat': '34.20670437', 'dschg_c': '-999999999999.0', 'wse': '475.9136', 'p_wid_var': '143.536', 'dschg_h': '-999999999999.0', 'dschg_i': '-999999999999.0', 'loc_offset': '-304.0919', 'dschg_hsf': '-999999999999', 'slope2_u': '-999999999999.0', 'time_tai': '735449041.692', 'p_n_nodes': '79', 'dschg_gb_q': '-999', 'reach_id': '74227800151', 'dschg_o_u': '-999999999999.0', 'dschg_s_q': '-999', 'dschg_gb_u': '-999999999999.0', 'dschg_s_u': '-999999999999.0', 'reach_q_b': '52230', 'slope': '0.00154019389', 'dschg_o_q': '-999', 'dschg_m': '-999999999999.0', 'dschg_c_q': '-999', 'dschg_o': '-999999999999.0', 'dschg_c_u': '-999999999999.0', 'dschg_s': '-999999999999.0', 'dschg_ghsf': '-999999999999', 'p_low_slp': '0', 'area_det_u': '6495.6', 'slope_r_u': '4.597113e-05', 'dschg_ssf': '-999999999999', 'load_tideg': '-0.0129605181', 'dschg_gbsf': '-999999999999', 'wse_r_u': '4.09576', 'dschg_osf': '-999999999999', 'load_tidef': '-0.0126287434', 'dschg_gm_u': '-999999999999.0', 'dschg_csf': '-999999999999', 'width_c_u': '-999999999999.0', 'p_maf': '-999999999999.0', 'dschg_gi_q': '-999', 'obs_frac_n': '0.25316455696', 'dschg_gm_q': '-999', 'dschg_gi_u': '-999999999999.0', 'p_wse_var': '36.6891653', 'dschg_gq_b': '-99999999', 'dry_trop_c': '-2.18908011', 'd_x_area_u': '-999999999999.0', 'rch_id_dn': '74227800131, no_data, no_data, no_data', 'wse_c': '-999999999999.0', 'dschg_b_q': '-999', 'dschg_gssf': '-999999999999', 'dschg_b_u': '-999999999999.0', 'width': '22.965048', 'geometry': 'LINESTRING (-100.124087 34.237217, -100.124087 34.237217, -100.124413 34.237214, -100.124741 34.237373, -100.125068 34.237478, -100.125395 34.237584, -100.125721 34.237581, -100.126046 34.237578, -100.126373 34.237629, -100.126698 34.237626, -100.127024 34.237623, -100.127351 34.237674, -100.127676 34.237671, -100.128001 34.237614, -100.128326 34.237557, -100.128651 34.2375, -100.128976 34.237443, -100.129301 34.237385, -100.129626 34.237328, -100.129951 34.237271, -100.130275 34.23716, -100.1306 34.237049, -100.130924 34.236938, -100.131248 34.236826, -100.131572 34.236715, -100.131897 34.236604, -100.13222 34.236439, -100.132544 34.236273, -100.132867 34.236108, -100.13319 34.235889, -100.133513 34.235669, -100.133771 34.23545, -100.133963 34.235232, -100.134155 34.23496, -100.134282 34.234688, -100.134408 34.234416, -100.1346 34.234144, -100.134792 34.233872, -100.134918 34.2336, -100.13511 34.233328, -100.135237 34.233056, -100.135363 34.232784, -100.13549 34.232513, -100.135682 34.23224, -100.135809 34.231969, -100.135935 34.231697, -100.136062 34.231425, -100.136254 34.231153, -100.136445 34.230881, -100.136702 34.230608, -100.137026 34.230442, -100.137349 34.230277, -100.137673 34.230166, -100.137998 34.230109, -100.138324 34.230106, -100.138648 34.229994, -100.138973 34.229937, -100.139297 34.229826, -100.139621 34.229661, -100.139944 34.229495, -100.140526 34.229111, -100.140526 34.229111, -100.140783 34.228892, -100.140976 34.228674, -100.141167 34.228402, -100.141294 34.22813, -100.141421 34.227858, -100.141482 34.227587, -100.141544 34.227316, -100.141475 34.227046, -100.141341 34.226777, -100.141207 34.226508, -100.141008 34.226239, -100.140809 34.22597, -100.14061 34.225702, -100.140476 34.225432, -100.140342 34.225163, -100.140273 34.224893, -100.140139 34.224624, -100.140071 34.224354, -100.140002 34.224084, -100.139933 34.223814, -100.139864 34.223544, -100.139926 34.223273, -100.139987 34.223002, -100.140049 34.222731, -100.14011 34.22246, -100.140172 34.222189, -100.140168 34.221918, -100.140164 34.221648, -100.140226 34.221377, -100.140287 34.221106, -100.140414 34.220834, -100.140606 34.220562, -100.140797 34.220289, -100.141247 34.219798, -100.141247 34.219798, -100.141504 34.219579, -100.141762 34.21936, -100.142085 34.219195, -100.14241 34.219084, -100.142734 34.218973, -100.143058 34.218861, -100.143383 34.218804, -100.143708 34.218747, -100.144033 34.21869, -100.144358 34.218633, -100.144682 34.218576, -100.145007 34.218519, -100.145333 34.218515, -100.145658 34.218458, -100.145983 34.218401, -100.146308 34.218398, -100.146634 34.218395, -100.146958 34.218284, -100.147283 34.218227, -100.147608 34.21817, -100.147933 34.218112, -100.148258 34.218055, -100.148583 34.217998, -100.148908 34.217941, -100.149232 34.217884, -100.149557 34.217827, -100.149882 34.21777, -100.150208 34.217766, -100.150533 34.217709, -100.150858 34.217652, -100.151182 34.217595, -100.151507 34.217538, -100.151832 34.217481, -100.152158 34.217478, -100.152483 34.21742, -100.152808 34.217363, -100.153133 34.217306, -100.153457 34.217249, -100.153782 34.217192, -100.154108 34.217189, -100.154434 34.217186, -100.154758 34.217129, -100.155083 34.217071, -100.155408 34.217014, -100.155732 34.216903, -100.156057 34.216792, -100.156381 34.216734, -100.156706 34.216677, -100.15703 34.216566, -100.157355 34.216509, -100.157679 34.216398, -100.158003 34.216232, -100.158326 34.216067, -100.15865 34.215901, -100.158972 34.215682, -100.159296 34.215517, -100.159619 34.215351, -100.159877 34.215132, -100.160069 34.214914, -100.160261 34.214696, -100.160388 34.214424, -100.160449 34.214153, -100.160576 34.213881, -100.160702 34.21361, -100.160764 34.213338, -100.16089 34.213067, -100.161017 34.212795, -100.161078 34.212524, -100.16114 34.212253, -100.161266 34.211981, -100.161328 34.21171, -100.161389 34.211439, -100.16145 34.211168, -100.161512 34.210896, -100.161508 34.210626, -100.161504 34.210355, -100.161436 34.210086, -100.161367 34.209816, -100.161298 34.209546, -100.161164 34.209277, -100.160965 34.209008, -100.160831 34.208739, -100.160697 34.208469, -100.160563 34.2082, -100.160429 34.207931, -100.16036 34.207661, -100.160292 34.207391, -100.160158 34.207122, -100.160089 34.206852, -100.16015 34.206581, -100.160277 34.206309, -100.160469 34.206091, -100.160792 34.205925, -100.161117 34.205814, -100.161441 34.205757, -100.161767 34.205754, -100.162093 34.205751, -100.162418 34.205748, -100.162744 34.205745, -100.163069 34.205742, -100.163396 34.205793, -100.163722 34.205844, -100.164049 34.205949, -100.164376 34.206054, -100.164702 34.206105, -100.165028 34.206102, -100.165354 34.206099, -100.165678 34.205987, -100.165936 34.205823, -100.166129 34.205658, -100.166321 34.20544, -100.166448 34.205168, -100.166509 34.204897, -100.166636 34.204625, -100.166762 34.204354, -100.166824 34.204083, -100.166885 34.203812, -100.166946 34.20354, -100.167008 34.203269, -100.167069 34.202998, -100.167131 34.202727, -100.167192 34.202456, -100.167253 34.202185, -100.16725 34.201914, -100.167246 34.201644, -100.167307 34.201373, -100.167369 34.201102, -100.167495 34.20083, -100.167622 34.200558, -100.167748 34.200286, -100.16781 34.200015, -100.167936 34.199743, -100.168062 34.199472, -100.168254 34.199199, -100.168511 34.198926, -100.168833 34.198653, -100.169154 34.198379, -100.169476 34.198106, -100.169798 34.197832, -100.17012 34.197558, -100.170442 34.197285, -100.170698 34.197012, -100.170955 34.196739, -100.171212 34.196466, -100.171468 34.196193, -100.171726 34.195974, -100.172049 34.195808, -100.172373 34.195697, -100.172698 34.19564, -100.173024 34.195637, -100.173349 34.195634, -100.173675 34.195685, -100.174002 34.195736, -100.174328 34.195787, -100.174654 34.195838, -100.174981 34.195943, -100.175308 34.195994, -100.175634 34.196045, -100.175961 34.19615, -100.176288 34.196255, -100.176615 34.19636, -100.176943 34.196519, -100.177271 34.196678, -100.177598 34.196783, -100.177925 34.196943, -100.178253 34.197102, -100.17858 34.197207, -100.178908 34.197366, -100.179237 34.197579, -100.179565 34.197793, -100.179894 34.198006, -100.180222 34.198219, -100.18055 34.198378, -100.180878 34.198537, -100.181205 34.198642, -100.181531 34.198693, -100.181858 34.198798, -100.182185 34.198904, -100.182512 34.198954, -100.182838 34.199005, -100.183165 34.199111, -100.183491 34.199161, -100.183818 34.199212, -100.184144 34.199263, -100.18447 34.199314, -100.184796 34.199311, -100.185121 34.199308, -100.185448 34.199359, -100.185774 34.19941, -100.186101 34.199515, -100.186429 34.199674, -100.186692 34.199888, -100.186891 34.200103, -100.18709 34.200371, -100.187224 34.20064, -100.187293 34.20091, -100.187427 34.20118, -100.187561 34.201449, -100.18763 34.201719, -100.187764 34.201988, -100.187963 34.202256, -100.188097 34.202526, -100.188296 34.202794, -100.18856 34.203062, -100.188825 34.20333, -100.189088 34.203544, -100.189417 34.203757, -100.189745 34.203971, -100.190073 34.20413, -100.1904 34.204235, -100.190728 34.204394, -100.191055 34.204499, -100.191382 34.204604, -100.191709 34.204655, -100.192035 34.204706, -100.192361 34.204703, -100.192686 34.2047, -100.193011 34.204642, -100.193336 34.204639, -100.193662 34.204636, -100.193988 34.204633, -100.194313 34.20463, -100.194639 34.204626, -100.194964 34.204569, -100.195288 34.204458, -100.195612 34.204346, -100.195935 34.204181, -100.196257 34.203961, -100.196581 34.203796, -100.196904 34.20363, -100.197226 34.203411, -100.197549 34.203191, -100.197806 34.202972, -100.198063 34.202699, -100.198255 34.202427, -100.198316 34.202156, -100.198312 34.201885, -100.198308 34.201615, -100.198239 34.201345, -100.19817 34.201075, -100.198166 34.200805, -100.198163 34.200534, -100.198159 34.200264, -100.198155 34.199993, -100.198151 34.199723, -100.198147 34.199452, -100.198078 34.199182, -100.198009 34.198912, -100.19794 34.198642, -100.197872 34.198373, -100.197803 34.198103, -100.197799 34.197832, -100.197795 34.197562, -100.197791 34.197291, -100.197787 34.197021, -100.197783 34.19675, -100.19778 34.19648, -100.197776 34.196209, -100.197772 34.195939, -100.197768 34.195668, -100.197764 34.195398, -100.197761 34.195127, -100.197822 34.194856, -100.197948 34.194584, -100.19814 34.194312, -100.198396 34.194039, -100.198719 34.193819, -100.199041 34.1936, -100.199364 34.193434, -100.199688 34.193323, -100.200013 34.193266, -100.200337 34.193154, -100.200662 34.193097, -100.200987 34.19304, -100.201311 34.192928, -100.201635 34.192817, -100.201959 34.19276, -100.202284 34.192702, -100.202608 34.192591, -100.202933 34.192534, -100.203258 34.192476, -100.203582 34.192365, -100.203906 34.192254, -100.20423 34.192142, -100.204554 34.192031, -100.204878 34.191919, -100.205202 34.191862, -100.205526 34.191751, -100.205851 34.191693, -100.206176 34.191636, -100.206501 34.191579, -100.206825 34.191467, -100.207149 34.191356, -100.207473 34.191245, -100.207796 34.191079, -100.208118 34.190859, -100.208441 34.190694, -100.208765 34.190528, -100.209088 34.190363, -100.209412 34.190251, -100.209736 34.19014, -100.21006 34.190029, -100.210384 34.189971, -100.210709 34.189914, -100.211034 34.189857, -100.211359 34.189854, -100.211685 34.18985, -100.21201 34.189847, -100.212336 34.189844, -100.212662 34.189895, -100.212989 34.189946, -100.213316 34.190051, -100.213643 34.19021, -100.213971 34.190369, -100.214299 34.190528, -100.214627 34.190687, -100.214954 34.190792, -100.215281 34.190897, -100.215608 34.191002, -100.215934 34.190999, -100.216259 34.190995, -100.216585 34.190992, -100.216909 34.190935, -100.217234 34.190878, -100.21756 34.190874, -100.217885 34.190871, -100.21821 34.190814, -100.218535 34.19081, -100.21886 34.190753, -100.219185 34.190696, -100.219509 34.190584, -100.219833 34.190473, -100.220156 34.190307, -100.220479 34.190142, -100.220802 34.189976, -100.221126 34.189811, -100.221449 34.189699, -100.221773 34.189534, -100.222096 34.189368, -100.222419 34.189203, -100.222743 34.189091, -100.223067 34.18898, -100.223391 34.188868, -100.223716 34.188811, -100.22404 34.188754, -100.224364 34.188642, -100.224688 34.188531, -100.225013 34.188473, -100.225338 34.188416, -100.225662 34.188305, -100.225986 34.188247, -100.226311 34.18819, -100.226636 34.188133, -100.22696 34.188075, -100.227287 34.188126, -100.227613 34.188177, -100.227939 34.188228, -100.228266 34.188333, -100.228593 34.188438, -100.228921 34.188543, -100.229248 34.188702, -100.229512 34.188915, -100.230039 34.189343, -100.230039 34.189343, -100.230303 34.189557, -100.230303 34.189557, -100.230895 34.189984, -100.231223 34.190197, -100.231553 34.190464, -100.231882 34.190677, -100.23221 34.19089, -100.232538 34.191049, -100.232866 34.191208, -100.233194 34.191367, -100.233522 34.191526, -100.233849 34.191631, -100.234177 34.19179, -100.234504 34.191895, -100.23483 34.191946, -100.235156 34.191997, -100.235483 34.192048, -100.235809 34.192099, -100.236135 34.192149, -100.236462 34.1922, -100.236788 34.192251, -100.237114 34.192302, -100.23744 34.192299, -100.237765 34.192295, -100.238091 34.192292, -100.238416 34.192289, -100.238742 34.192285, -100.239067 34.192282, -100.239393 34.192279)', 'wse_u': '4.09675', 'node_dist': '85.0142331', 'dschg_gosf': '-999999999999', 'rch_id_up': '74227800176, no_data, no_data, no_data', 'range_start_time': '2023-04-22T03:22:06Z', 'river_name': 'no_data', 'dark_frac': '0.0', 'slope2': '0.001568786', 'p_n_ch_mod': '1', 'range_end_time': '2023-04-22T03:22:13Z', 'n_good_nod': '20', 'time_str': '2023-04-22T03:23:24Z', 'dschg_bsf': '-999999999999', 'p_dist_out': '607722.998', 'p_length': '15733.121708', 'partial_f': '1', 'dschg_gh_u': '-999999999999.0', 'wse_c_u': '-999999999999.0', 'geoid_slop': '6.99831e-06', 'n_reach_up': '1', 'pole_tide': '-0.0020703804', 'p_width': '42.0', 'dschg_gh_q': '-999', 'dschg_m_q': '-999', 'dschg_i_u': '-999999999999.0', 'p_lon': '-100.1771731', 'dschg_m_u': '-999999999999.0', 'dschg_q_b': '-99999999', 'dschg_i_q': '-999', 'd_x_area': '-999999999999.0', 'ice_dyn_f': '-999', 'n_reach_dn': '1', 'area_detct': '185303.6', 'reach_q': '1', 'xovr_cal_c': '0.0', 'width_c': '-999999999999.0', 'dschg_gs': '-999999999999.0', 'pass_id': '011', 'dschg_gm': '-999999999999.0', 'dschg_isf': '-999999999999', 'area_tot_u': '6495.6176', 'dschg_msf': '-999999999999', 'dschg_go': '-999999999999.0', 'dschg_go_u': '-999999999999.0', 'dschg_gs_q': '-999', 'layovr_val': '7.109', 'xtrk_dist': '-9565.10742', 'dschg_gc': '-999999999999.0', 'xovr_cal_q': '2', 'geoid_hght': '-28.906834', 'width_u': '0.805015', 'dschg_gi': '-999999999999.0', 'continent_id': 'NA', 'dschg_gh': '-999999999999.0', 'dschg_gs_u': '-999999999999.0', 'ice_clim_f': '0', 'dschg_gb': '-999999999999.0', 'dschg_go_q': '-999', 'area_wse': '185303.6', 'dschg_gc_q': '-999', 'cycle_id': '498', 'p_n_ch_max': '1', 'crid': 'PIB0', 'dschg_gc_u': '-999999999999.0', 'solid_tide': '-0.1410012506', 'slope_u': '4.606892e-05', 'dschg_h_u': '-999999999999.0', 'p_wse': '478.399994', 'slope2_r_u': '0.15707158644', 'wet_trop_c': '-0.0672157043', 'dschg_h_q': '-999', 'iono_c': '-0.0062133416', 'dschg_gisf': '-999999999999', 'time': '735449004.692', 'p_dam_id': '0', 'dschg_gmsf': '-999999999999'}]
    gdf = hydrocron.api.controllers.timeseries.convert_to_df(items)
    assert_almost_equal(np.array([478.2167, 475.9136], dtype=np.float64), gdf['wse'].to_numpy().astype(np.float64))
    assert_almost_equal(np.array([16.677122, 22.965048], dtype=np.float64), gdf['width'].to_numpy().astype(np.float64))
    assert_almost_equal(np.array([0.0010608586, 0.00154019389], dtype=np.float64), gdf['slope'].to_numpy().astype(np.float64))


def test_timeseries_lambda_handler_missing(hydrocron_api):
    """
    Test the lambda handler for the timeseries endpoint for missing parameters
    Parameters
    ----------
    hydrocron_api: Fixture ensuring the database is configured for the api
    """
    import hydrocron.api.controllers.timeseries

    event = {"body": {}}
    context = "_"
    with pytest.raises(hydrocron.api.controllers.timeseries.RequestError) as e:
        hydrocron.api.controllers.timeseries.lambda_handler(event, context)
        assert "400: This required parameter is missing: 'feature'" in str(e.value)

    event = {
        "body": {
            "feature": "Reach",
            "start_time": "2023-06-04T00:00:00Z",
            "end_time": "2023-06-23T00:00:00Z",
            "output": "geojson",
            "fields": "reach_id,time_str,wse,geometry"
        }
    }
    context = "_"
    with pytest.raises(hydrocron.api.controllers.timeseries.RequestError) as e:
        hydrocron.api.controllers.timeseries.lambda_handler(event, context)
        assert "400: This required parameter is missing: 'feature_id'" in str(e.value)


def test_timeseries_lambda_handler_feature(hydrocron_api):
    """
    Test the lambda handler for the timeseries endpoint for feature parameter
    Parameters
    ----------
    hydrocron_api: Fixture ensuring the database is configured for the api
    """
    import hydrocron.api.controllers.timeseries

    event = {
        "body": {
            "feature": "River",
            "feature_id": "71224100223",
            "start_time": "2023-06-04T00:00:00Z",
            "end_time": "2023-06-23T00:00:00Z",
            "output": "geojson",
            "fields": "reach_id,time_str,wse,geometry"
        }
    }

    context = "_"
    with pytest.raises(hydrocron.api.controllers.timeseries.RequestError) as e:
        hydrocron.api.controllers.timeseries.lambda_handler(event, context)
        assert "400: feature parameter should be Reach or Node, not: River" in str(e.value)


def test_timeseries_lambda_handler_feature_id(hydrocron_api):
    """
    Test the lambda handler for the timeseries endpoint for feature_id parameter
    Parameters
    ----------
    hydrocron_api: Fixture ensuring the database is configured for the api
    """
    import hydrocron.api.controllers.timeseries

    event = {
        "body": {
            "feature": "Reach",
            "feature_id": "7122ff4100223",
            "start_time": "2023-06-04T00:00:00Z",
            "end_time": "2023-06-23T00:00:00Z",
            "output": "geojson",
            "fields": "reach_id,time_str,wse,geometry"
        }
    }

    context = "_"
    with pytest.raises(hydrocron.api.controllers.timeseries.RequestError) as e:
        hydrocron.api.controllers.timeseries.lambda_handler(event, context)
        assert "400: feature_id cannot contain letters: 7122ff4100223" in str(e.value)


def test_timeseries_lambda_handler_dates(hydrocron_api):
    """
    Test the lambda handler for the timeseries endpoint for start_time and 
    end_time parameters
    Parameters
    ----------
    hydrocron_api: Fixture ensuring the database is configured for the api
    """
    import hydrocron.api.controllers.timeseries

    event = {
        "body": {
            "feature": "Reach",
            "feature_id": "71224100223",
            "start_time": "2023/06/04T00:00:00Z",
            "end_time": "2023-06-23T00:00:00Z",
            "output": "geojson",
            "fields": "reach_id,time_str,wse,geometry"
        }
    }

    context = "_"
    with pytest.raises(hydrocron.api.controllers.timeseries.RequestError) as e:
        hydrocron.api.controllers.timeseries.lambda_handler(event, context)
    assert "400: start_time and end_time parameters must conform to format: YYYY-MM-DDTHH:MM:SS+00:00" in str(e.value)


def test_timeseries_lambda_handler_output(hydrocron_api):
    """
    Test the lambda handler for the timeseries output parameters
    Parameters
    ----------
    hydrocron_api: Fixture ensuring the database is configured for the api
    """
    import hydrocron.api.controllers.timeseries

    event = {
        "body": {
            "feature": "Reach",
            "feature_id": "71224100223",
            "start_time": "2023-06-04T00:00:00Z",
            "end_time": "2023-06-23T00:00:00Z",
            "output": "txt",
            "fields": "reach_id,time_str,wse,geometry"
        }
    }

    context = "_"
    with pytest.raises(hydrocron.api.controllers.timeseries.RequestError) as e:
        hydrocron.api.controllers.timeseries.lambda_handler(event, context)
        assert "400: output parameter should be csv or geojson, not: txt" in str(e.value)


def test_timeseries_lambda_handler_fields(hydrocron_api):
    """
    Test the lambda handler for the timeseries output parameters
    Parameters
    ----------
    hydrocron_api: Fixture ensuring the database is configured for the api
    """
    import hydrocron.api.controllers.timeseries

    event = {
        "body": {
            "feature": "Reach",
            "feature_id": "71224100223",
            "start_time": "2023-06-04T00:00:00Z",
            "end_time": "2023-06-23T00:00:00Z",
            "output": "geojson",
            "fields": "reach_id,time_str,wse,geometry,height"
        }
    }

    context = "_"
    with pytest.raises(hydrocron.api.controllers.timeseries.RequestError) as e:
        hydrocron.api.controllers.timeseries.lambda_handler(event, context)
        assert "400: fields parameter should contain valid SWOT fields" in str(e.value)
